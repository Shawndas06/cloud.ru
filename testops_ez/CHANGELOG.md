# Changelog - Исправления базового функционала

## Версия 1.1.0 - Исправление генерации и валидации тестов

### Критические исправления

#### 1. Генератор тестов (`agents/generator/generator.py`)
- ✅ **Исправлено**: Автоматическое добавление всех обязательных Allure декораторов
  - Теперь проверяется наличие всех 4 декораторов: `@allure.feature`, `@allure.story`, `@allure.title`, `@allure.tag`
  - Если хотя бы одного декоратора нет, добавляются все автоматически
  - Для API тестов автоматически добавляется `@pytest.mark.asyncio` для async функций
  - Улучшена логика определения feature и story на основе названия теста

- ✅ **Исправлено**: Добавление проверок (assert) для тестов без assertions
  - Для API тестов добавляется проверка статус кода после запроса
  - Для UI тестов добавляется allure.step с проверкой

#### 2. CloudRuAPIGenerator (`agents/generator/cloud_ru_api_generator.py`)
- ✅ **Исправлено**: Добавление всех обязательных декораторов для API тестов
  - Автоматическое добавление `@pytest.mark.asyncio`, `@allure.feature`, `@allure.story`, `@allure.title`, `@allure.tag`
  - Правильная обработка async функций

#### 3. Валидатор (`agents/validator/validator_agent.py`)
- ✅ **Исправлено**: Более гибкая логика валидации
  - Отсутствие декораторов теперь считается **warning**, а не **error**
  - Для API тестов отсутствие assertions также считается warning, а не error
  - Тесты с синтаксически правильным кодом проходят валидацию даже при отсутствии декораторов

#### 4. Workflow генерации (`workers/tasks/generate_workflow.py`, `workers/tasks/generate_api_workflow.py`, `workers/tasks/langgraph/nodes.py`)
- ✅ **Исправлено**: Логика определения статуса валидации
  - Статус "passed" теперь присваивается если:
    - Нет синтаксических ошибок И
    - (validation.passed = True ИЛИ score >= 50)
  - Тесты с score >= 50 и без синтаксических ошибок получают статус "passed"
  - Все тесты сохраняются, даже если есть warnings

#### 5. Промпты (`agents/generator/prompts.py`)
- ✅ **Улучшено**: Явное указание на необходимость генерации 15+ тестов
  - Для ручных тестов: минимум 15 тест-кейсов
  - Для автоматизированных тестов: минимум 10 тест-кейсов
  - Для API тестов: минимум 3-5 тестов на endpoint

### Реализованный функционал

#### ✅ Генерация ручных тест-кейсов для UI калькулятора (15+ кейсов)
- Анализ веб-страницы через Playwright
- Генерация ручных тест-кейсов с декоратором `@allure.manual`
- Описание шагов в docstring
- Все декораторы добавляются автоматически

**Пример использования:**
```bash
POST /api/v1/generate/test-cases
{
  "url": "https://cloud.ru/calculator",
  "requirements": ["Проверить калькулятор"],
  "test_type": "manual",
  "options": {"manual_count": 15}
}
```

#### ✅ Генерация ручных тест-кейсов для API VMs (15+ кейсов)
- Парсинг OpenAPI спецификации
- Генерация тестов для всех endpoints
- Минимум 3-5 тестов на endpoint (в сумме 15+)

**Пример использования:**
```bash
POST /api/v1/generate/api-tests
{
  "openapi_url": "https://compute.api.cloud.ru/openapi.yaml",
  "endpoints": ["/api/v1/vms"],
  "test_types": ["positive", "negative"]
}
```

#### ✅ Генерация автоматизированных e2e тестов (pytest + Playwright)
- Автоматический анализ структуры страницы
- Генерация Playwright тестов с Allure декораторами
- Паттерн AAA (Arrange-Act-Assert)
- Использование allure.step() для структурирования

**Пример использования:**
```bash
POST /api/v1/generate/test-cases
{
  "url": "https://cloud.ru/calculator",
  "requirements": ["Проверить калькулятор"],
  "test_type": "automated",
  "options": {"automated_count": 10}
}
```

#### ✅ Генерация автоматизированных API тестов (pytest + httpx)
- Генерация pytest тестов для API endpoints
- Покрытие positive/negative/edge cases
- Использование httpx.AsyncClient
- Все декораторы добавляются автоматически

**Пример использования:**
```bash
POST /api/v1/generate/api-tests
{
  "openapi_url": "https://compute.api.cloud.ru/openapi.yaml",
  "endpoints": ["/api/v1/vms"],
  "test_types": ["positive", "negative"]
}
```

#### ✅ Валидация генерируемых тест-кейсов
- Многоуровневая валидация (синтаксис, семантика, логика, безопасность)
- Проверка Allure декораторов (warning, не error)
- Safety Guard (4 уровня защиты)
- Детальный отчет с рекомендациями

#### ✅ Интеграция с Cloud.ru Evolution Foundation Model
- Использование `cloud_ru_foundation_models_url` и `cloud_ru_api_key`
- Модель по умолчанию: `ai-sage/GigaChat3-10B-A1.8B`
- Кэширование ответов LLM в Redis

#### ✅ Работающий Docker setup
- `docker-compose.yml` с полной конфигурацией
- Frontend (nginx) на порту 3000
- API Gateway (FastAPI) на порту 8000
- Celery Worker для асинхронной обработки
- PostgreSQL с pgvector
- Redis для очередей и кэша
- Flower для мониторинга Celery

**Запуск:**
```bash
docker-compose up -d
```

#### ✅ Базовая документация
- `README.md` с полным описанием функционала
- Примеры использования всех API endpoints
- Инструкции по запуску и настройке
- Описание архитектуры

### Технические детали

#### Изменения в логике валидации
**До:**
- Отсутствие декораторов = error → тест не проходит валидацию
- Статус "warning" для всех тестов с любыми проблемами

**После:**
- Отсутствие декораторов = warning → тест проходит валидацию
- Статус "passed" если нет синтаксических ошибок и score >= 50
- Все тесты сохраняются в БД

#### Изменения в генераторе
**До:**
- Декораторы добавлялись только если их вообще не было
- Не проверялось наличие всех обязательных декораторов

**После:**
- Проверяется наличие всех 4 обязательных декораторов
- Если хотя бы одного нет, добавляются все автоматически
- Правильное определение feature и story

### Известные ограничения

1. **Количество тестов**: LLM может генерировать меньше тестов, чем запрошено. В этом случае генератор извлекает все доступные тесты из ответа.

2. **Качество тестов**: Зависит от качества промптов и модели LLM. Рекомендуется использовать более мощные модели для лучших результатов.

3. **Валидация**: Тесты с синтаксическими ошибками не сохраняются. Тесты с warnings сохраняются, но со статусом "warning".

### Следующие шаги

1. ✅ Исправлена генерация тестов
2. ✅ Исправлена валидация тестов
3. ✅ Исправлены статусы валидации
4. ✅ Улучшены промпты
5. ⏳ Тестирование на реальных данных
6. ⏳ Оптимизация производительности

### Версия
**1.1.0** - 2024

